import{d as L,r as y,w as z,o as J,a as Y,c as D,b as v,e as g,f as M,g as u,h as X,i as Z,v as k,j as S,k as x,t as p,F as B,l as V,u as Q,n as ee,_ as te}from"./index-Basy082J.js";import{h as se,g as ae}from"./errorHandler-CM8Dv8ir.js";async function oe(f,e=5,a){if(!f||f.trim().length<2)return[];try{const{data:t}=await se.get("/geo/1.0/direct",{params:{q:f,limit:e},signal:a});return t||[]}catch(t){throw t}}class re{static defaultConfig={maxRetries:3,baseDelay:1e3,maxDelay:1e4,retryCondition:e=>e.canRetry&&["network","timeout","server"].includes(e.type)};static async withRetry(e,a={}){const t={...this.defaultConfig,...a};let i;for(let h=0;h<=t.maxRetries;h++)try{return await e()}catch(n){if(i=n,h===t.maxRetries||t.retryCondition&&!this.shouldRetryError(n))break;const l=Math.min(t.baseDelay*Math.pow(2,h),t.maxDelay),_=l*.25*(Math.random()-.5),b=Math.max(100,l+_);console.log(`Retry attempt ${h+1}/${t.maxRetries} after ${Math.round(b)}ms`),await this.sleep(b)}throw i}static shouldRetryError(e){return e?.code==="ERR_NETWORK"||e?.code==="ECONNABORTED"||e?.code==="ERR_TIMEOUT"||e?.response?.status>=500||e?.response?.status===429}static sleep(e){return new Promise(a=>setTimeout(a,e))}static createRetryWrapper(e,a={}){return((...t)=>this.withRetry(()=>e(...t),a))}}const ne={AGGRESSIVE:{maxRetries:5,baseDelay:500,maxDelay:8e3},STANDARD:{maxRetries:3,baseDelay:1e3,maxDelay:5e3},CONSERVATIVE:{maxRetries:2,baseDelay:1500,maxDelay:3e3},FAST:{maxRetries:2,baseDelay:300,maxDelay:1e3}};async function ie(f,e="STANDARD"){return re.withRetry(f,ne[e])}class le{activeRequests=new Map;debounceTimers=new Map;throttleTimers=new Map;lastRequestTimes=new Map;requestIds=new Map;cancelRequest(e){const a=this.activeRequests.get(e);a&&(a.abort(),this.activeRequests.delete(e));const t=this.debounceTimers.get(e);t&&(window.clearTimeout(t),this.debounceTimers.delete(e));const i=this.throttleTimers.get(e);i&&(window.clearTimeout(i),this.throttleTimers.delete(e))}createRequest(e){this.cancelRequest(e);const a=new AbortController;this.activeRequests.set(e,a);const t=(this.requestIds.get(e)||0)+1;return this.requestIds.set(e,t),a}async executeWithThrottleDebounce(e,a,t={}){const{debounceMs:i=300,throttleMs:h=1e3,timeoutMs:n=1e4,strategy:l="debounce",enableRetry:_=!1,retryConfig:b="STANDARD"}=t;return new Promise((m,A)=>{const w=Date.now(),q=this.lastRequestTimes.get(e)||0,T=async()=>{try{this.lastRequestTimes.set(e,w);const c=_?()=>this.executeRequestOnce(e,a,n):()=>this.executeRequestOnce(e,a,n),d=_?await ie(c,b||"STANDARD"):await c(),R=this.requestIds.get(e);this.requestIds.get(e)===R?m(d):m(null)}catch(c){c instanceof Error&&(c.name==="AbortError"||c.code==="ERR_CANCELED"||c.name==="CanceledError")?m(null):A(c)}};if(l==="throttle")if(w-q>=h)T();else{const c=h-(w-q),d=this.throttleTimers.get(e);d&&window.clearTimeout(d);const R=window.setTimeout(()=>{this.throttleTimers.delete(e),T()},c);this.throttleTimers.set(e,R)}else if(l==="debounce"){const c=this.debounceTimers.get(e);c&&window.clearTimeout(c);const d=window.setTimeout(()=>{this.debounceTimers.delete(e),T()},i);this.debounceTimers.set(e,d)}else if(l==="both")if(w-q>=h){const c=this.debounceTimers.get(e);c&&window.clearTimeout(c);const d=window.setTimeout(()=>{this.debounceTimers.delete(e),T()},i);this.debounceTimers.set(e,d)}else{const d=h-(w-q)+i,R=this.debounceTimers.get(e);R&&window.clearTimeout(R);const I=window.setTimeout(()=>{this.debounceTimers.delete(e),T()},d);this.debounceTimers.set(e,I)}})}async executeRequestOnce(e,a,t){const i=this.createRequest(e),h=this.requestIds.get(e),n=setTimeout(()=>{i.abort()},t);try{const l=await a(i.signal,h);return clearTimeout(n),this.activeRequests.delete(e),l}catch(l){throw clearTimeout(n),this.activeRequests.delete(e),l}}async executeWithDebounce(e,a,t={}){return this.executeWithThrottleDebounce(e,a,{...t,strategy:"debounce"})}cancelAllRequests(){for(const[e]of this.activeRequests)this.cancelRequest(e)}hasActiveRequest(e){return this.activeRequests.has(e)}getStats(){return{activeRequests:this.activeRequests.size,pendingDebounces:this.debounceTimers.size}}destroy(){this.cancelAllRequests(),this.requestIds.clear()}}const ce={SEARCH:{debounceMs:350,throttleMs:1e3,timeoutMs:8e3,strategy:"debounce",enableRetry:!0,retryConfig:"CONSERVATIVE"},AUTOCOMPLETE:{debounceMs:200,throttleMs:500,timeoutMs:5e3,strategy:"debounce",enableRetry:!1},REFRESH:{debounceMs:100,throttleMs:2e3,timeoutMs:1e4,strategy:"both",enableRetry:!0,retryConfig:"STANDARD"},CRITICAL:{debounceMs:0,throttleMs:3e3,timeoutMs:15e3,strategy:"throttle",enableRetry:!0,retryConfig:"AGGRESSIVE"}},ue={class:"home-search home-search--container"},he={key:0,class:"alert alert-danger mb-4",role:"alert"},de={class:"home-search__input-wrapper"},me=["onKeydown"],ve=["disabled"],ge={key:0,class:"home-search__suggestions",role:"listbox",id:"home-search-suggestions"},_e={key:0,class:"home-search__suggestion-item home-search__suggestion-item--loading"},be={class:"home-search__loading-content"},fe={class:"home-search__loading-info"},Re={class:"home-search__loading-text"},pe={class:"home-search__loading-stats"},we={key:1,class:"home-search__suggestion-item home-search__suggestion-item--empty"},Te=["onMouseenter","onMousedown"],ye={class:"home-search__suggestion-name"},qe={class:"home-search__suggestion-coords"},Ee={key:1,class:"home-search__error"},xe={key:2,class:"home-search__recent-section"},Me={class:"home-search__recent-list"},De=["onClick","title"],Se=["onClick"],C="weather_recent_cities",Ae=L({__name:"HomeSearch",setup(f){const e=Q(),a=y(""),t=y([]),i=y(!1),h=y(""),n=y(!1),l=y(-1),_=new Map,b=new le,m=y([]),A=()=>{const s=localStorage.getItem(C);s&&(m.value=JSON.parse(s))},w=s=>{const o=[s,...m.value.filter(r=>r.lat!==s.lat||r.lon!==s.lon)].slice(0,5);m.value=o,localStorage.setItem(C,JSON.stringify(o))},q=(s,o)=>{m.value=m.value.filter(r=>r.lat!==s||r.lon!==o),localStorage.setItem(C,JSON.stringify(m.value))};z(a,s=>{if(h.value="",l.value=-1,!s||s.trim().length<2){b.cancelRequest("city-search"),t.value=[],n.value=!1,i.value=!1;return}N(s.trim())});const T=async()=>{const s=a.value.trim();if(s){if(_.has(s)){t.value=_.get(s)||[],n.value=t.value.length>0;return}await N(s)}},c=s=>[s.name,s.state,s.country].filter(Boolean).join(", "),d=s=>{n.value=!1,t.value=[],a.value="",w(s),e.push({name:"weather",query:{lat:String(s.lat),lon:String(s.lon),name:s.name}})},R=()=>{!n.value||!t.value.length||(l.value=(l.value+1)%t.value.length)},I=()=>{!n.value||!t.value.length||(l.value=(l.value-1+t.value.length)%t.value.length)},F=()=>{if(!n.value||!t.value.length)return;const s=t.value[l.value];s&&d(s)},P=()=>{n.value=!1},$=()=>{if(!(i.value||a.value.trim().length<2)){if(n.value&&t.value.length){const s=l.value>=0?l.value:0,o=t.value[s];if(o){d(o);return}}T()}},G=()=>{setTimeout(()=>{n.value=!1},150)};J(()=>{A()});const N=async s=>{if(_.has(s)){t.value=_.get(s)||[],n.value=t.value.length>0,i.value=!1;return}try{i.value=!0;const o=await b.executeWithThrottleDebounce("city-search",async(r,E)=>({data:await oe(s,5,r),requestId:E,query:s}),ce.SEARCH);o&&o.query===a.value.trim()&&(t.value=o.data,_.set(s,o.data),n.value=!0,h.value="")}catch(o){H(o)}finally{i.value=!1}},H=s=>{const o=ae(s,"search-cities");o&&(h.value=o)};Y(()=>{b.destroy()});const U=D(()=>!i.value&&n.value&&t.value.length===0&&a.value.trim().length>=2),O=D(()=>b.hasActiveRequest("city-search")),K=D(()=>b.getStats()),j=D(()=>!0);return(s,o)=>(g(),v("div",ue,[j.value?M("",!0):(g(),v("div",he,[...o[1]||(o[1]=[X('<h4 class="alert-heading" data-v-441bb507>‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è</h4><p class="mb-2" data-v-441bb507><strong data-v-441bb507>API –∫–ª—é—á OpenWeatherMap –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!</strong></p><p class="mb-2" data-v-441bb507> –î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª <code data-v-441bb507>.env.local</code> –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞: </p><pre class="text-dark bg-light p-2 rounded" data-v-441bb507><code data-v-441bb507>VITE_OWM_API_KEY=–≤–∞—à_api_–∫–ª—é—á_–∑–¥–µ—Å—å</code></pre><hr data-v-441bb507><p class="mb-0" data-v-441bb507> üìã –ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –∫–ª—é—á –Ω–∞ <a href="https://openweathermap.org/api" target="_blank" rel="noopener noreferrer" class="alert-link" data-v-441bb507> OpenWeatherMap </a></p>',6)])])),o[5]||(o[5]=u("h1",{class:"home-search__title"},"–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞",-1)),u("form",{class:"home-search__form",role:"search",onSubmit:x($,["prevent"])},[u("div",de,[Z(u("input",{class:"home-search__input",type:"text","onUpdate:modelValue":o[0]||(o[0]=r=>a.value=r),placeholder:"–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Kyiv)","aria-autocomplete":"list","aria-controls":"home-search-suggestions",onKeydown:[S(x(R,["prevent"]),["down"]),S(x(I,["prevent"]),["up"]),S(x(F,["prevent"]),["enter"]),S(P,["esc"])],onBlur:G},null,40,me),[[k,a.value,void 0,{trim:!0}]]),u("button",{class:"home-search__search-btn",type:"submit",disabled:i.value||a.value.trim().length<2,"aria-label":"–ù–∞–π—Ç–∏ –≥–æ—Ä–æ–¥"},[...o[2]||(o[2]=[u("svg",{class:"home-search__search-icon",xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[u("circle",{cx:"11",cy:"11",r:"8"}),u("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})],-1)])],8,ve)]),n.value?(g(),v("div",ge,[i.value||O.value?(g(),v("div",_e,[u("div",be,[u("div",fe,[o[3]||(o[3]=u("div",{class:"home-search__spinner"},null,-1)),u("span",Re,p(O.value?"–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤...":"–ó–∞–≥—Ä—É–∑–∫–∞..."),1)]),u("div",pe,p(K.value.pendingDebounces>0?"‚è∞ Debounce":"")+" "+p(K.value.activeRequests>0?"üåê API":""),1)])])):U.value?(g(),v("div",we," –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ")):M("",!0),(g(!0),v(B,null,V(t.value,(r,E)=>(g(),v("div",{key:r.lat+":"+r.lon+r.name,class:ee(["home-search__suggestion-item",{"home-search__suggestion-item--active":E===l.value}]),role:"option",onMouseenter:W=>l.value=E,onMousedown:x(W=>d(r),["prevent"])},[u("div",ye,p(c(r)),1),u("div",qe," ("+p(r.lat.toFixed(2))+", "+p(r.lon.toFixed(2))+") ",1)],42,Te))),128))])):M("",!0)],32),h.value?(g(),v("div",Ee,p(h.value),1)):M("",!0),m.value.length?(g(),v("div",xe,[o[4]||(o[4]=u("div",{class:"home-search__subtitle"},"–ù–µ–¥–∞–≤–Ω–∏–µ:",-1)),u("div",Me,[(g(!0),v(B,null,V(m.value,r=>(g(),v("div",{key:r.lat+":"+r.lon+r.name,class:"home-search__recent-chip"},[u("button",{class:"home-search__recent-btn",onClick:E=>d(r),title:c(r)},p(c(r)),9,De),u("button",{class:"home-search__recent-remove",onClick:x(E=>q(r.lat,r.lon),["stop"]),"aria-label":"–£–¥–∞–ª–∏—Ç—å –∏–∑ –Ω–µ–¥–∞–≤–Ω–∏—Ö"}," √ó ",8,Se)]))),128))])])):M("",!0)]))}}),Ne=te(Ae,[["__scopeId","data-v-441bb507"]]);export{Ne as default};
